version : '3'

tasks:

  # Build packages
  build: 
    desc: Build the current package against the unstable repo
    dir: '{{ .USER_WORKING_DIR }}'
    vars:
      PROFILE: '{{ default "unstable-x86_64" .PROFILE }}'
      SPECFILE:
        sh: if [ -f package.yml ]; then echo "package.yml"; else echo "pspec.xml"; fi;
    preconditions:
      - test -f package.yml || test -f pspec.xml
    cmds:
      - sudo solbuild build {{ .SPECFILE }} -p {{ .PROFILE }} {{ .CLI_ARGS }}

  build-stable:
    desc: Build the current package against the stable repo (do NOT use for official submissions!)
    cmds:
      - task: build
        vars: 
          PROFILE: 'main-x86_64'
      - |
        echo "=========================================================================="
        echo "WARNING: This package was built against -stable and is for local use only."
        echo "                                                                          "
        echo "         Do NOT publish packages or Differentials built against -stable!!!"
        echo "=========================================================================="

  local:
    desc: "Build the current package against the unstable and the default local repo"
    cmds:
      - task: build
        vars: 
          PROFILE: 'local-unstable-x86_64'

  # Modify packages
  bump:
    desc: Bump current release
    dir: '{{ .USER_WORKING_DIR }}'
    cmds:
      - |
        if [[ -e package.yml ]]; then
          echo "package.yml present!"
        	python /usr/share/ypkg/ybump.py /package.yml;
        else
        	./common/Scripts/pbump.py pspec.xml;
        fi;
  
  convert:
    desc: Convert pspec to package.yml
    dir: '{{ .USER_WORKING_DIR }}'
    preconditions:
      - test -f pspec.xml
    cmds:
      - |
        "{{ .TASKFILE_DIR }}/common/Scripts/yconvert.py" pspec.xml

  # For packagers
  publish:
    dir: '{{ .USER_WORKING_DIR }}'
    conditions:
      - test -f package.yml || test -f pspec.xml
      # We're on master branch
      - test $(git symbolic-ref HEAD 2>/dev/null) = "refs/heads/master"
      # Tag has not been created
      - 
    cmds:
      - 

  republish:
    desc: Rebuild existing tag
    dir: '{{ .USER_WORKING_DIR }}'
    conditions:
      - test -f package.yml || test -f pspec.xml
      # We're on master branch
      - test $(git symbolic-ref HEAD 2>/dev/null) = "refs/heads/master"
    cmds:
      - task: push

  push:
    desc: Push package to the build server
    internal: true
    dir: '{{ .USER_WORKING_DIR }}'
    vars:
      SOURCE: '{{ .USER_WORKING_DIR }}'
      TAG:
    cmds:
      - ssh build-controller@build.getsol.us build "{{ .SOURCE }}" "{{ .TAG }}"

  # Other utilities
  clean:
    desc: Clean current tree
    dir: '{{ .USER_WORKING_DIR }}'
    preconditions:
      - test -f *.eopkg
    cmds:
      - rm *.eopkg -fv

  pull:
    desc: Pull/rebase latest changes
    dir: '{{ .USER_WORKING_DIR }}'
    preconditions:
      - test -d .git
    cmds:
      - git pull --rebase

  switch-domains:
    desc: Update local repositories to use correct hostname
    cmds:
      - go run "{{ .TASKFILE_DIR }}/common/Go/switch_repo_domains.go"
